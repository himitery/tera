{{- $NOTICE := "\n=== NOTICE" -}}
{{- $WARNING := "\n=== WARNING" -}}
{{- $CRITICAL := "\n=== CRITICAL" -}}

{{- /* If any development subchart is enabled, note it is not production ready */}}
{{- $enabledNonProdCharts := fromJsonArray (include "gitlab.nonProdCharts.enabledNames" .) -}}
{{- if not (empty $enabledNonProdCharts) }}
{{ $CRITICAL }}
The following charts are included for evaluation purposes only. They will not be supported by GitLab Support
for production workloads. Use Cloud Native Hybrid deployments for production. For more information visit
https://docs.gitlab.com/charts/installation/index.html#use-the-reference-architectures.
{{- range $name := $enabledNonProdCharts }}
- {{ $name }}
{{- end }}
{{- end }}

{{- /* PostgreSQL minimum version change */}}
{{ $NOTICE }}
The minimum required version of PostgreSQL is now 14. See https://docs.gitlab.com/charts/installation/upgrade.html for more details.

{{- /* If the Container Registry metadata database is enabled */}}
{{- if eq .Values.registry.database.enabled true }}
{{ $WARNING }}
The Container Registry metadata database has been enabled.
Carefully review the documentation https://docs.gitlab.com/charts/charts/registry/metadata_database.html before enabling the registry database in production!
If you encounter a problem with either the import or operation of the registry, please add a comment in the feedback issue https://gitlab.com/gitlab-org/gitlab/-/issues/423459#supported-feature-status.
{{- end }}

{{- /* If the Container Registry database load balancing is enabled */}}
{{- if eq .Values.registry.database.loadBalancing.enabled true }}
{{ $WARNING }}
The Container Registry database load balancing feature has been enabled. This is an experimental feature under active development and must not be used in production.
{{- end }}

{{- /* Notifications endpoint threshold should use maxretries instead */ -}}
{{- $usesThreshold := false }}
{{- range $v := .Values.global.registry.notifications.endpoints }}
    {{- if hasKey $v "threshold" }}
        {{- $usesThreshold = true}}
    {{- end }}
{{- end }}
{{- if $usesThreshold }}
{{ $NOTICE }}
registry:
    The configuration of `global.registry.notifications.endpoints[].threshold` has been deprecated and is planned for removal in GitLab 18.0.
    Please use `global.registry.notifications.endpoints[].maxretries` instead https://gitlab.com/gitlab-org/container-registry/-/issues/1243.
{{- end -}}
{{- /* END gitlab.deprecate.registry.notifications.endpoints.threshold */}}

{{- /* If shared-secrets is disable, manual secret creation will be needed */}}
{{- if not (index .Values "shared-secrets").enabled }}
{{ $NOTICE }}
The automatic generation of secrets has been disabled.
The user should ensure all necessary secrets are created according to documentation, or the deployment will fail to operate correctly.
{{- end }}

{{- /* Deprecation notice for global.redis.password */}}
{{- if kindIs "map" .Values.global.redis.password }}
{{ $NOTICE }}
redis:
    The configuration key `global.redis.password` has been renamed. Please use
    `global.redis.auth` instead. This is the source of the `coalesce.go` warning
    message from Helm as well. For more details, please see:
    https://docs.gitlab.com/charts/installation/upgrade.html#use-of-globalredispassword
{{- end -}}

{{- /* run removals */}}
{{ include "gitlab.removals" . }}
{{- /* run checkConfig */}}
{{ include "gitlab.checkConfig" . }}
